#!/usr/bin/env bash
#
# Smart Business Discovery Pipeline (v3)
#
# Next-gen lead generation with:
# âœ… Multi-source discovery (seed list, CME, Innovation Canada)
# âœ… Contact enrichment (email/phone discovery)
# âœ… Source performance tracking
# âœ… Automatic fallback logic
#
# Usage:
#   ./generate_v3 [count] [--show] [--industry=manufacturing]
#
# Examples:
#   ./generate_v3              # Generate 50 leads (default)
#   ./generate_v3 100          # Generate 100 leads
#   ./generate_v3 30 --show    # Generate 30 with progress details
#

set -euo pipefail

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Default values
COUNT="${1:-50}"
SHIFT_ARGS=1

# Parse remaining arguments
EXTRA_ARGS=""
if [ $# -gt 1 ]; then
    EXTRA_ARGS="${@:2}"
fi

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ğŸš€ Smart Business Discovery Pipeline (v3)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "  Target: ${GREEN}${COUNT}${NC} qualified leads"
echo -e "  Database: ${YELLOW}data/leads_v3.db${NC}"
echo -e "  Discovery: ${GREEN}Multi-source${NC} (seed list â†’ CME â†’ IC â†’ YellowPages â†’ OSM)"
echo -e "  Enrichment: ${GREEN}Contact discovery${NC} (emails, phones from websites)"
echo -e "  Validation: ${GREEN}5 strict gates${NC} (Category, Geo, Corroboration, Website, Revenue)"
echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Activate virtual environment if it exists
if [ -d "./venv" ]; then
    source ./venv/bin/activate
fi

# Run the pipeline
PYTHONPATH=. python3 src/pipeline/smart_discovery_pipeline.py "$COUNT" $EXTRA_ARGS

echo ""
echo -e "${GREEN}âœ… Pipeline complete!${NC}"
echo -e "   View results: ${YELLOW}sqlite3 data/leads_v3.db 'SELECT * FROM businesses WHERE status=\"QUALIFIED\" LIMIT 10;'${NC}"
echo -e "   Export CSV: ${YELLOW}python scripts/export_leads.py --db data/leads_v3.db${NC}"
echo ""
